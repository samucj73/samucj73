<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Previsor de Números da Roleta</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f7fa;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
      color: #2c3e50;
    }
    label, button {
      display: block;
      margin: 15px 0 5px;
    }
    input[type="file"], textarea, select, button {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      background-color: #2c3e50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #34495e;
    }
    canvas {
      max-width: 100%;
      margin-top: 20px;
    }
    #output, #charts, #ia-prediction {
      margin-top: 30px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container" id="content">
    <h1>Previsor de Números da Roleta</h1>
        <h2>Escolha como deseja inserir os dados:</h2>
    <label for="inputType">Tipo de entrada:</label>
    <select id="inputType" onchange="toggleInputFields()">
      <option value="image">Imagem (JPEG/PNG)</option>
      <option value="text">Texto Manual</option>
      <option value="file">Arquivo .txt</option>
    </select>

    <div id="imageInput">
      <label>Envie uma imagem:</label>
      <input type="file" accept="image/*" onchange="handleImage(this)">
    </div>

    <div id="textInput" class="hidden">
      <label>Digite os números separados por vírgulas:</label>
      <textarea id="manualNumbers" rows="5" placeholder="Ex: 12, 8, 25, 32, 14"></textarea>
      <button onclick="handleText()">Analisar Texto</button>
    </div>

    <div id="fileInput" class="hidden">
      <label>Envie um arquivo .txt:</label>
      <input type="file" accept=".txt" onchange="handleTxt(this)">
    </div>

    <button onclick="resetApp()" style="background-color: crimson;">Resetar Análises</button>

    <div id="output"></div>
    <div id="charts"></div>
    <div id="ia-prediction"></div>
    <div style="text-align:center; margin-top:30px;">
      <button onclick="gerarPDF()">Gerar PDF com Resultados</button>
    </div>
  </div>
  <script>
let numerosExtraidos = [];

function toggleInputFields() {
  const tipo = document.getElementById("inputType").value;
  document.getElementById("imageInput").classList.toggle("hidden", tipo !== "image");
  document.getElementById("textInput").classList.toggle("hidden", tipo !== "text");
  document.getElementById("fileInput").classList.toggle("hidden", tipo !== "file");
  document.getElementById("output").innerHTML = '';
  document.getElementById("charts").innerHTML = '';
  document.getElementById("ia-prediction").innerHTML = '';
}

function handleImage(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    Tesseract.recognize(e.target.result, 'eng').then(({ data: { text } }) => {
      const numeros = extrairNumeros(text);
      processarNumeros(numeros);
    });
  };
  reader.readAsDataURL(file);
}

function handleText() {
  const texto = document.getElementById("manualNumbers").value;
  const numeros = extrairNumeros(texto);
  processarNumeros(numeros);
}

function handleTxt(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const texto = e.target.result;
    const numeros = extrairNumeros(texto);
    processarNumeros(numeros);
  };
  reader.readAsText(file);
}

function extrairNumeros(texto) {
  return Array.from(texto.matchAll(/\d+/g)).map(n => parseInt(n)).filter(n => !isNaN(n));
}

function processarNumeros(numeros) {
  numerosExtraidos = numeros;
  if (numeros.length === 0) {
    document.getElementById("output").innerHTML = "<p>Nenhum número identificado.</p>";
    return;
  }

  document.getElementById("output").innerHTML = "<h3>Números Lidos:</h3><p>" + numeros.join(", ") + "</p>";
  analiseEstatistica(numeros);
  gerarGrafico(numeros);
  previsaoIA(numeros);
}

function analiseEstatistica(numeros) {
  const output = document.getElementById("output");
  const freq = {};
  numeros.forEach(n => freq[n] = (freq[n] || 0) + 1);
  const sorted = [...numeros].sort((a, b) => a - b);
  const media = (numeros.reduce((a, b) => a + b, 0) / numeros.length).toFixed(2);
  const mediana = sorted[Math.floor(sorted.length / 2)];
  const moda = Object.entries(freq).sort((a, b) => b[1] - a[1])[0][0];
  const desvio = Math.sqrt(numeros.reduce((a, b) => a + Math.pow(b - media, 2), 0) / numeros.length).toFixed(2);

  output.innerHTML += `
    <h3>Análises Estatísticas:</h3>
    <p><strong>Média:</strong> ${media}</p>
    <p><strong>Mediana:</strong> ${mediana}</p>
    <p><strong>Moda:</strong> ${moda}</p>
    <p><strong>Desvio Padrão:</strong> ${desvio}</p>
  `;
}

function gerarGrafico(numeros) {
  const freq = {};
  numeros.forEach(n => freq[n] = (freq[n] || 0) + 1);
  const labels = Object.keys(freq);
  const dados = Object.values(freq);

  document.getElementById("charts").innerHTML = `<canvas id="graficoFreq"></canvas>`;
  new Chart(document.getElementById("graficoFreq"), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Frequência dos Números',
        data: dados,
        backgroundColor: 'rgba(44, 62, 80, 0.6)',
        borderColor: 'rgba(44, 62, 80, 1)',
        borderWidth: 1
      }]
    },
    options: { responsive: true }
  });
}

async function previsaoIA(numeros) {
  if (numeros.length < 10) return;
  const xs = [], ys = [];
  for (let i = 0; i < numeros.length - 10; i++) {
    xs.push(numeros.slice(i, i + 10));
    ys.push(numeros[i + 10]);
  }

  const inputTensor = tf.tensor2d(xs, [xs.length, 10]);
  const outputTensor = tf.tensor1d(ys);

  const model = tf.sequential();
  model.add(tf.layers.dense({ inputShape: [10], units: 50, activation: 'relu' }));
  model.add(tf.layers.dense({ units: 25, activation: 'relu' }));
  model.add(tf.layers.dense({ units: 1 }));
  model.compile({ loss: 'meanSquaredError', optimizer: 'adam' });

  await model.fit(inputTensor, outputTensor, { epochs: 30, verbose: 0 });

  const entrada = tf.tensor2d([numeros.slice(-10)], [1, 10]);
  const pred = model.predict(entrada);
  const valor = (await pred.data())[0].toFixed(0);

  document.getElementById("ia-prediction").innerHTML =
    `<h3>Previsão por IA:</h3><p>Próximo número provável: <strong>${valor}</strong></p>`;
}

function gerarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const element = document.getElementById("content");

  html2canvas(element).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const imgProps = doc.getImageProperties(imgData);
    const pdfWidth = doc.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    doc.save("analise_roleta.pdf");
  });
}

function resetApp() {
  document.getElementById("output").innerHTML = '';
  document.getElementById("charts").innerHTML = '';
  document.getElementById("ia-prediction").innerHTML = '';
  document.getElementById("manualNumbers").value = '';
  numerosExtraidos = [];
}
</script>
</body>
</html>
